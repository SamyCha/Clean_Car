<div class="container">
  <div class="row text-right margin-top15">
    <div class="col-xs-10 col-xs-offset-2">
      <h2>My Clean Car</h2>
      <h6>book an eco wash</h6>
    </div>
  </div>

  <div class="row" id="<%= @car.id %>" style="height: 12vh; background-color: #e5e5e5; display: flex; align-items: center; margin: 0px">
      <div class="col-xs-4 col-xs-offset-1">
        <% if @car.car_picture && !@car.car_picture.blank? %>
          <%= image_tag @car.car_picture, class: "img-circle" %>
        <% else %>
          <%= image_tag "car_picto.png", style: "width: 80%; height: 9vh; background-color: white;", class: "img-circle" %>
        <% end %>
      </div>
      <div class="col-xs-7 ">
        <h4>
          <%= @car.brand %>
          <%= @car.model %>
          <%= @car.color %>
        </h4>
        <h6 style="display: flex; justify-content: space-around;">
          <small>
            <%= @car.immatriculation %>
          </small>
          <%= Category.find(@car.category_id).name %>
        </h6>
      </div>
  </div>

  <div class="row">
    <h6 style="margin-bottom: 3px; margin-left: 16px;">
      Enter your parking period
    </h6>
    <div class="col-xs-10 col-xs-offset-1">
      <%= image_tag "datepicker.png", style: "height: 45px;"%>
      <%= @cleaning.period.strftime('the %d/%m/%y at %Hh%M') %>
    </div>
  </div>

  <div class="row">
    <h6 style="margin-bottom: 3px; margin-left: 16px;">
      Car location during cleaning
    </h6>
    <div class="col-xs-10 col-xs-offset-1">
      <%= image_tag "localisation.png", style: "height: 45px;"%>
      <%= @cleaning.place %>
    </div>
  </div>

  <div class="row" style="margin-top: 50px; color: black;">
    <div class="col-xs-12">
      <p style="color: white;">Your cleaner :</p>
    </div>
    <div class="col-xs-12 card" style="padding: 5px; background-color: #e5e5e5; margin-bottom: 25px;">
      <div style="display: flex; align-items: center;">
        <div class="col-xs-3">
        <%= image_tag "profil.png", id: "logo", height: 60 %>
        </div>
        <div class="col-xs-3">
          <%= @cleaner.firstname %>
        </div>

        <div class="col-xs-4 col-xs-offset-2 text-center">
          <% unless @cleanings.where.not(rating: nil).blank? %>
            <% @cleanings.where.not(rating: nil).each do |cleaning| %>
              <% @ratings << cleaning.rating  %>
            <% end %>
            <%= (@ratings.sum / @ratings.size.to_f).to_s.first(3) %>
          <% else %>
            <h6>no rating yet</h6>
          <% end %>
        </div>
      </div>
    </div>

    <% if @cleaning.rating.blank? or  @cleaning.rating.nil? %>
      <% unless @cleaning.status == "complete" %>
        <div class="row" style="margin-bottom: 20px;">
          <div class="col-xs-12 text-center">
            <button href="#" class="progress-demo btn btn-primary ladda-button" data-style="zoom-in" data-size="xs" data-spinner-color="#fff"><span class="ladda-label">Pay to book this cleaning</span></a>
          </div>
        </div>
      <% else %>
        <div class="row ">
          <div class="col-xs-12 text-center btn-rating" >
            <strong>Rate this cleaning !</strong>
            <div class="btn-toolbar text-center margin-top15" role="toolbar" aria-label="...">
              <div class="btn-group" role="group" aria-label="..." style="float: none">
                <button type="button" class="btn btn-default">1</button>
                <button type="button" class="btn btn-default">2</button>
                <button type="button" class="btn btn-default">3</button>
                <button type="button" class="btn btn-default">4</button>
                <button type="button" class="btn btn-default">5</button>
              </div>
            </div>
          </div>
          <div class="col-xs-12 text-center thx-rating hidden" >
            <h3>Thank you for rating</h3>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="col-xs-12 text-center" style="margin-top: 30px;">
        <%= link_to "dashboard", dashboard_path, class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>

  <div id="cleaner-accepted" aria-hidden="true" aria-labelledby="cleaner-accepted" role="dialog" class="iziModal">
    <i class="iziModal-header-icon icon-power_settings_new"></i>
    <div class="iziModal-progressbar"></div>
    <div class="iziModal-wrap" style="height: auto;">
      <div class="iziModal-content" style="padding: 0;">
      </div>
    </div>
  </div>

</div>

<script>
  Ladda.bind( 'div:not(.progress-demo) btn', { timeout: 4000 } );
  Ladda.bind( '.progress-demo', {
    callback: function( instance ) {
      var progress = 0;
      var interval = setInterval( function() {
          progress = Math.min( progress + Math.random() * 0.1, 1 );
          instance.setProgress( progress );
          if( progress === 1 ) {
            instance.stop();
            clearInterval( interval );
          }
      }, 200 );
    }
  });

  $(document).ready(function(){
    $('.btn-group>button').on('click', function(e) {
      var rating = $(this).text();
      $('.btn-rating').addClass('hidden');
      $('.thx-rating').removeClass('hidden');
      window.setTimeout(function() {
        if (rating == 1)
          <% @cleaning.update(rating: 1) %>;
        else if (rating == 2)
          <% @cleaning.update(rating: 2) %>;
        else if (rating == 3)
          <% @cleaning.update(rating: 3) %>;
        else if (rating == 4)
          <% @cleaning.update(rating: 4) %>;
        else if (rating == 5)
          <% @cleaning.update(rating: 5) %>;
      }, 2000);
    });
  });
</script>
